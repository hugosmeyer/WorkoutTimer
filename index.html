async function runScript() {
  const lines = scriptBox.value.trim().split("\n").map(line => line.trim());
  const commandTree = parseCommands(lines);
  const flatCommands = flattenCommands(commandTree);
  await executeCommands(flatCommands);
  progressBar.value = 1;
}

function parseCommands(lines) {
  const stack = [[]];

  for (let line of lines) {
    if (line === "") continue;

    if (line.startsWith("loop:")) {
      const newBlock = [];
      stack[stack.length - 1].push({ type: "loop", commands: newBlock, repeat: 1 });
      stack.push(newBlock);
    } else if (line.startsWith("repeat:")) {
      const count = parseInt(line.slice(7).trim()) || 1;
      const block = stack.pop();
      const parent = stack[stack.length - 1];
      const loopCmd = parent[parent.length - 1];
      if (loopCmd && loopCmd.type === "loop") {
        loopCmd.repeat = count;
      }
    } else if (line.startsWith("say:")) {
      stack[stack.length - 1].push({ type: "say", text: line.slice(4).trim() });
    } else if (line.startsWith("wait:")) {
      stack[stack.length - 1].push({ type: "wait", seconds: parseFloat(line.slice(5).trim()) });
    }
  }

  return stack[0];
}

function flattenCommands(tree) {
  const result = [];

  function expand(commands) {
    for (let cmd of commands) {
      if (cmd.type === "loop") {
        for (let i = 0; i < cmd.repeat; i++) {
          expand(cmd.commands);
        }
      } else {
        result.push(cmd);
      }
    }
  }

  expand(tree);
  return result;
}

async function executeCommands(commands) {
  for (let i = 0; i < commands.length; i++) {
    const cmd = commands[i];
    progressBar.value = i / commands.length;

    if (cmd.type === "say") {
      const u = new SpeechSynthesisUtterance(cmd.text);
      u.lang = 'en-US';
      u.voice = speechSynthesis.getVoices().find(v => v.lang === 'en-US');
      await new Promise(r => {
        u.onend = r;
        speechSynthesis.speak(u);
      });
    } else if (cmd.type === "wait") {
      await new Promise(r => setTimeout(r, cmd.seconds * 1000));
    }
  }
}
